parameters:
  - name: artifactName
    type: string
    default: terraform-plan
  - name: environmentVariables
    type: object
    default: []
  - name: region
    type: string
  - name: stack
    type: string
  - name: subscriptionId
    type: string
  - name: workingDirectory
    type: string
    default: $(Build.Repository.LocalPath)

steps:
  - script: |
      terragrunt plan -out=tfplan -detailed-exitcode --terragrunt-ignore-external-dependencies
      
      # Sets a variable that can be used to skip the apply step.
      # If the Apply step is used in a different stage then the condition can be set at the stage level
      if [[ $? -eq 0 ]]; then
        echo "##vso[task.setvariable variable=skipApply]true"
      fi

      if [[ $? -eq 1 ]]; then
        set -e
        exit 1
      fi
    displayName: Terragrunt Plan
    env:
      ARM_CLIENT_ID: $(AZURE_SERVICE_PRINCIPAL_ID)
      ARM_CLIENT_SECRET: $(AZURE_SERVICE_PRINCIPAL_SECRET)
      ARM_SUBSCRIPTION_ID: ${{ parameters.subscriptionId }}
      ARM_TENANT_ID: $(AZURE_TENANT_ID)
      TERRAGRUNT_WORKING_DIR: ${{ parameters.workingDirectory }}
      TF_INPUT: false
      ${{ each var in parameters.environmentVariables }}:
        ${{ var.key }}: ${{ var.value }}
  - task: CopyFiles@2
    displayName: Copy tfplan and lock to artifact
    inputs:
      flattenFolders: true
      SourceFolder: ${{ parameters.workingDirectory }}
      Contents: |
        ${{ parameters.workingDirectory }}/.terragrunt-cache/**/${{ parameters.region }}/${{ parameters.stack }}/.terraform.lock.hcl
        ${{ parameters.workingDirectory }}/.terragrunt-cache/**/${{ parameters.region }}/${{ parameters.stack }}/tfplan
      TargetFolder: $(Build.ArtifactStagingDirectory)
  - script: |
      find ${{ parameters.workingDirectory }}/.terragrunt-cache -name .terraform -type d -exec cp -r {} $(Build.ArtifactStagingDirectory)/.terraform \;
    displayName: Copy .terraform folder to artifact
  - publish: $(Build.ArtifactStagingDirectory)
    artifact: ${{ parameters.artifactName }}
    displayName: Publish sources
