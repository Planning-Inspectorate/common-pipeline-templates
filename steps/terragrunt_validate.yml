parameters:
- name: environmentVariables
  type: object
  default: []
- name: serviceConnection
  type: string
- name: subscriptionId
  type: string
- name: workingDirectory
  type: string
  default: $(Build.Repository.LocalPath)

steps:
  - task: AzureCLI@2
    displayName: Azure Authentication
    inputs:
      scriptType: bash
      scriptLocation: inlineScript
      azureSubscription: ${{ parameters.serviceConnection }}
      addSpnToEnvironment: true
      inlineScript: |
        echo "##vso[task.setvariable variable=azureClientId]$servicePrincipalId"
        echo "##vso[task.setvariable variable=azureClientSecret]$servicePrincipalKey"
        echo "##vso[task.setvariable variable=azureTenantId]$tenantId"
  - script: |
      terragrunt run-all validate --terragrunt-include-external-dependencies
    displayName: Terragrunt Validate
    env:
      ARM_CLIENT_ID: $(azureClientId)
      ARM_CLIENT_SECRET: $(azureClientSecret)
      ARM_SUBSCRIPTION_ID: ${{ parameters.subscriptionId }}
      ARM_TENANT_ID: $(azureTenantId)
      TERRAGRUNT_WORKING_DIR: ${{ parameters.workingDirectory }}
      TF_INPUT: false
      ${{ each var in parameters.environmentVariables }}:
        ${{ var.key }}: ${{ var.value }}
